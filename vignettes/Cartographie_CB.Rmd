---
title: "Cartographie"
output: html_document
---

## Chargement des packages

```{r}
library(tidyverse)
library(dplyr)
library(reshape2)
library(ggmap) # Pour la cartographie
library(raster)
library(cartography)
library(leaflet)
library(lubridate)
```

## Exploration des données de coordonnées gps et recodages nécessaires

```{r}
summary(accidents[,c(12,13)])
```

2622 lignes n'ont pas de coordonnées gps renseignées.

```{r}
class(accidents$lat)
class(accidents$long)
```

Nous observons que les variables lat et long sont au format caractères. Nous commençons par les recoder afin qu'elles soient au format de degrés décimaux (format classique coordonnées gps).

```{r}
accidents$lat <- type.convert(accidents$lat, dec=".")
class(accidents$lat)
accidents$long <- type.convert(accidents$long, dec=".")
class(accidents$long)
accidents$lat <- as.numeric(accidents$lat)
accidents$long <- as.numeric(accidents$long)
```

```{r}
accidents_gps <- accidents %>%
 mutate(lat = case_when(
              abs(lat) > 100 ~ lat/100000,
              TRUE ~ lat),
        long = case_when(
              abs(long) > 100 ~ long/100000,
              TRUE ~ long)
        )
```

```{r}
summary(accidents_gps[,c(12,13)])
```

On crée un dataframe contenant le nombre d'accidents par coordonnées gps

```{r}
accidents_gps_group <- accidents_gps %>%
  dplyr::select(Num_Acc, dep, date_acc, lat, long) %>%
  dplyr::group_by(Num_Acc, lat, long, date_acc) %>%
  summarise(n = n()) %>%
  dplyr::select(Num_Acc, lat, long, date_acc)
```

Combien d'accidents avec des coordonnées gps renseignées nulles ? 

```{r}
accidents_gps_group %>% filter(lat==0, long==0) 
```

On obtient 13 043 accidents sans coordonnées gps renseignées sur 236 570 soit 5,5 %. On les retire de la base accidents_gps_group.

```{r}
accidents_gps_group <- accidents_gps_group %>%
  filter(lat != 0, long != 0)
```

```{r}
summary(accidents_gps_group[,c(2,3)])
```

## Cartographie

On cherche les coins de la carte avec la fonction make_bbox du package ggmap

```{r}
bbox <- make_bbox(long, lat, data=accidents_gps_group)
bbox
```

```{r}
Carte <- get_map(bbox)
ggmap(Carte)
```

La carte n'est pas centrée sur la France comme nous le souhaiterions.

```{r}
la <- 48.293024
lo <- 4.079306
zoom <- 4
#Carte <- get_map(bbox)
#ggmap(Carte)
Carte2 <- get_map(location=c(lon = 1.7, lat = 47), zoom = 6, source="google", maptype="terrain", crop=TRUE, language= "fr-FR")
ggmap(Carte2)
```

L'accès à l'API de Google nécessite un enregistrement avec communication d'une CB. J'abandonne cette piste. 

Création de la carte de France puis conversion au format sf pour utilisation avec le package cartography

```{r}
library(sf)
library(sp)
fr <- getData('GADM', country='FRA', level=1)
plot(fr)
is(fr)
frsf <- st_as_sf(fr, "sf") # Conversion au format sf
st_bbox(frsf) # Identifier les limites
```

```{r}
plot(fr, col = "lightblue4", border = "lightblue3", bg = "lightblue1")
```

On colore les régions les plus accidentogènes.

```{r}
accidents_2018 <- accidents_gps_group %>%
  filter(year(date_acc) == 2018)

france <- leaflet(data=accidents_2018) %>%
  setView(lng=1.7, lat=47, zoom=5) %>%
  addTiles()
print(france)
```

```{r}
#france %>% addCircles(~long, ~lat, weight = 0.25)
```

Les modalités de la variable grav dans la table accidents : 

```{r}
accidents %>% dplyr::select(grav) %>% 
  group_by(grav) %>%
  summarise(n=n())
```

On compte 4 modalités, on va colorer les points du jaune au rouge, du niveau de gravité le plus faible (Indemne) au niveau le plus grave (Tué).

```{r}
accidents_2018_bis <- accidents_gps %>%
  dplyr::filter(year(date_acc)==2018) %>%
  dplyr::select(Num_Acc, grav, lat, long)

accidents_2018_bis <- accidents_2018_bis[1:10000,]
```

```{r}
#accidents_2018_bis$grav <- factor(sample.int(4L, nrow(accidents_2018_bis), TRUE))

#factpal <- colorFactor(topo.colors(4), accidents_2018_bis$grav)
factpal <- colorFactor(c("firebrick","orange","gold","forestgreen"), accidents_2018_bis$grav)

factpal(accidents_2018_bis$grav[1:10])

france_test <- leaflet(data=accidents_2018_bis) %>%
  setView(lng=1.7, lat=47, zoom=5) %>%
  addTiles() %>%
  addCircleMarkers(~long, 
                   ~lat, 
                   radius=1, 
                   color=~factpal(grav),
                   fillOpacity = 0.5)
print(france_test)
```





