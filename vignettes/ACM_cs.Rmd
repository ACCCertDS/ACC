---
title: "Analyses des Correspondances Multiples et Classification sur la base accidents"
output: html_notebook
author : CS
date : 06/03/2021
---

Bibliothèques utiles à l’éxécution du programme
```{r}
library(tidyverse)
library(dbplyr)
library(FactoMineR) # pour les ACM
library(mclust) # pour la classification
library(klaR) # pour les K-modes
library(ACC)
```


Préparation de la base de travail
```{r}
data("population", package = "ACC")
accidents2 <-  mutate_pour_modele(accidents, population)

# Suppression des variables d'identifiants et les variables quantitatives
base <- accidents2 %>%
  dplyr::select(-Num_Acc)

# résumé de la base
summary(base)
names(base)
```


# Etude 1 - ACM sur l'ensemble des variables qualitatives de la base de données

Dans cette première ACM, on intègre toutes les variables qualitatives.

## ACM
```{r}
res.mca <- MCA(base,
                level.ventil = 0.025)
# toutes les modalités représentant moins de 2.5 % sont ventilées aléatoirement dans les autres modalités (les tués représentent 2,7 % des accidents, d'où le filtre à 2,5 % car on veut garder la modalité "tué")
```


## Réprésentation graphique des poids des dimensions
```{r}
# Tableau avec les poids des axes
res.mca$eig[,2]

# Histogramme
barplot(res.mca$eig[,2], names = paste("Dim", 1:nrow(res.mca$eig)))
```

Au vu du coude, on ne garderait que 7 axes. Toutefois, cela représente assez peu (22 %), ce qui est normal en ACM.


## Réprésentation graphique des individus
```{r}
plot(res.mca, invisible = "var",
     title = "Représentation des individus selon les 2 premiers axes de l'ACM")
```

Vu le nombre d'individus, aucun intérêt car pas lisible.


## Représentation graphique des modalités des variables
```{r}
plot(res.mca, invisible = "ind",
     title = "Représentation des modalités selon les 2 premiers axes de l'ACM")
```
Même constat que pour le graphique précédent, trop de modalités et peu lisible.


## Résumé des stats de l'ACM
```{r}
summary(res.mca, nbelements=2, # nombre d'individus
        ncp=5, # nombre de dimensions
        nb.dec=2) 
```


# Etude 2 - on regarde la gravité des blessures selon le profil des usagers

Dans cette 2e ACM, on étudie le fait d'être Indemne/Blessé selon les données démographiques des victimes (age, sexe, catégorie d'usagers).

## ACM
```{r}
# rq : on ne garde que les variables démographiques (sexe, age, catégorie d'usagers) et les autres sont passées en illustratives
res2.mca <- MCA(base, quali.sup = c(4:20,22), level.ventil = 0)
```


## Réprésentation graphique des poids des dimensions
```{r}
# Tableau avec les poids
res2.mca$eig[,2]

# Histogramme
barplot(res2.mca$eig[,2], names = paste("Dim", 1:nrow(res2.mca$eig)))
```

Au vu du graph, on peut garder 2 axes, qui explique 22 %.

## Réprésentation graphique des individus
```{r}
plot(res2.mca, invisible = c("var","quali.sup"),
     title = "Représentation des individus selon les 2 premiers axes de l'ACM")
```

Vu le nombre d'individus, peu d'intérêt car pas lisible.


## Représentation graphique des individus selon les modalités de la variable "grav"
```{r}
plot(res2.mca, invisible = c("var","quali.sup"),
     habillage = "grav",
     title = "Représentation des individus selon les modalités de la variable gravité")
```

Sur l'axe 2, les personnes idemnes (en bas) se détachent des personnes tuées (en haut)


## Représentation graphique des individus selon les modalités de la variable "catégorie d'usager"
```{r}
plot(res2.mca, invisible = c("var","quali.sup"),
     habillage = "catu",
     title = "Représentation des individus selon la catégorie d'usager")
```

Selon l'axe 2, on peut observer qu'un groupe "passager" se détache vers le bas (personnes indemnes), par oppoistion au groupe "piétons" vers le haut (personnes tuées)


## Représentation graphique des modalités des variables
```{r}
plot(res2.mca, invisible = "ind",
     title = "Représentation des modalités actives (rouge) et des modalités illustratives (vert) selon les 2 premiers axes de l'ACM")
```

## Représentation graphique des modalités des variables (sans les variables illustratives)
```{r}
plot(res2.mca, invisible = c("ind","quali.sup"),
     title = "Représentation des modalités actives selon les 2 premiers axes de l'ACM")
```

Sur l'axe 1: 
a) à gauche, plutôt des hommes, les classes d'âges intermédiaires (25-64 ans), conducteur et indemne
b) à droite les âges extrêmes (moins de 15 ans ou 75 ans et plus), femmes, passagers ou piétons et blessés

Sur l'axe 2 :
a) en haut : les personnes de plus de 75 ans / piéton / tué 
b) en bas : les personnes de moins de 25 ans / passager / blessé léger


## Représentation graphique des ellipses de confiance
```{r}
plotellipses(res2.mca, keepvar = c("grav", "sexe", "catu", "classe_age"))
```
L'axe 1 distingue les hommes (à gauche) des femmes (à droite). De même, les conducteurs sont à gauche et les piétons à droite.
L'axe 2 distingue les jeunes (en bas) des personnes âgées (en haut). Les jeunes sont plutôt des passagers, les classes d'âges intermédiaires des conducteurs et les personnes plus âgées des piétons.

Cette représentation graphique conforte les groupes mis en avant à l'étape précédente.


## Résumé des stats de l'ACM
```{r}
summary(res2.mca, nbelements=5, # nombre d'individus
        ncp=2, # nombre de dimensions
        nb.dec=2) 
```
     

# Etude 3 - on regarde la gravité des blessures selon les caractéristiques du lieu et du véhicule

Dans cette 3e ACM, on s'intéresse aux conditions de la route, météo et du véhicules

## ACM
```{r}
res3.mca <- MCA(base, quali.sup = c(1,3,21), 
                level.ventil = 0.025) 
# toutes les modalités représentant moins de 2.5 % sont ventilées aléatoirement dans les autres modalités (les tués représentent 2,7 % des accidents, d'où le filtre à 2,5 % car on veut garder la modalité "tué")
```


## Réprésentation graphique des poids des dimensions
```{r}
# Tableau avec les poids
res3.mca$eig[,2]

# Histogramme
barplot(res3.mca$eig[,2], names = paste("Dim", 1:nrow(res3.mca$eig)))
```

On garde 5 axes, soit 18.3 %.


## Réprésentation graphique des individus
```{r}
plot(res3.mca, invisible = c("var","quali.sup"),
     title = "Représentation des individus selon les 2 premiers axes de l'ACM")
```

Vu le nb d'individus, pas d'intérêt car pas lisible

## Représentation graphique des individus selon les modalités de la variable "grav"
```{r}
plot(res3.mca, invisible = c("var","quali.sup"),
     habillage = "grav",
     title = "Représentation des individus selon les modalités de la variable gravité")
```

Sur l'axe 2, les personnes indemnes (en bas) se détachent des personnes tuées (en haut)


## Représentation graphique des modalités des variables
```{r}
plot(res3.mca, invisible = "ind",
     title = "Réprésentation des modalités actives (rouge) et des modalités illustratives (vert) selon les 2 premiers axes de l'ACM")
```


## Représentation graphique des modalités des variables (sans les variables illustratives)
```{r}
plot(res3.mca, invisible = c("ind","quali.sup"),
     title = "Représentation des modalités actives selon les 2 premiers axes de l'ACM")
```


L'axe 1 est discriminant sur la catégorie de route : voie communale à gauche contre route nationale/autoroute à droite.
De même, on a les accidents en agglomération à droite et ceux hors agglo à gauche (cohérent avec l'analyse précédente).
Enfin, la luminosité conforte cette analyse : nuit avec éclairage (en agglo - à gauche) et nuit sans écalirage (hors agglo - à droite)

L'axe 2 distingue le profil : accidents en pente en haut et accident sur route "plate" en bas.
De même, le régime de circulation explique cet axe : sens unique ou chaussées séparées en bas contre bidirectionnelle en haut.
Enfin, on a une nette opposition entre les personnes indemnes en bas et les blessés/hospitalisés en haut.


## Représentation graphique des ellipses de confiance
```{r}
#plotellipses(res3.mca, keepvar = c("grav", "catr", "agg", "secu1", "catv", "col", "plan"))
```


## Résumé des stats de l'ACM
```{r}
summary(res3.mca, nbelements=20, # nombre d'individus (permet aussi de voir la contribution de toutes les variables aux axes)
        ncp=5, # nombre de dimensions
        nb.dec=2) 
```



# Classification avec Mclust

```{r}
mod_classif <- Mclust(base)
summary(mod_classif) # 8 classes
```

## Analyse des classes
```{r}
# ajout des classes dans la base
base_comp <- cbind.data.frame(base,classe_mclust=as.factor(mod_classif$classification))

res_mclust <- catdes(base_comp, num.var = 2)  # on caractérise la variable "grav" (2e colonne dans la base)
```


## Quelles modalités sont le plus liées aux modalité de la gravité des blessures ?
```{r}
res_mclust$category
```

Grille de lecture (exemple pour les hommes et les personnes de 75 ans et plus) :
3.0 % des hommes ont été tués dans l'accident. Parmi les personnes tuées dans l'accident, 76,5 % sont des hommes. Enfin, les hommes représentent 68.8 % des personnes accidentées.
43.6 % des hommes sont sortis indemnes de l'accident. Parmi les personnes indemnes, 73.1 % sont des hommes.
31.0 % des personnes âgées de 75 ans et plus ont blessés hospitalisés dans l'accident. Parmi les personnes blessées hospitalisées dans l'accident, 8.0 % sont des personnes de 75 ans et plus. Enfin, les personnes âgées de 75 ans et plus représentent 5.2 % des personnes accidentées.


## Quelles modalités sont les plus présentes dans chaque classe  ?
```{r}
res_mclust2 <- catdes(base_comp, num.var = 23)  # on choisit la variable "classe"
res_mclust2$category
```
Classe 1 (81 193)
personne indemne - passager
entre 20h et 6h  + dimanche
voiture (100 %) + accident hors agglo + route non rectiligne + autoroute + conditions météo normales + nuit/crépuscule

Classe 2 (26 523)
homme + conducteur 
2 roues motorisé + présence d'une infrastructure + intersection / giratoire + secu1 2 roues

Classe 3 (28 425)
conducteur + indemne
conditions atmospheriques perturbées + hors agglo + secu1 voiture + poids lourd / engin agricole

Classe 4 (77 331)
conducteur + 15-24 ans + blessés (léger ou hospitalisé)
2 roues (vélo + moto) + en agglo + conditions météo normales + surf normale

Classe 5 (119 187)
hiver (entre nov et janv) + conditions météo dégradées + hors agglo + hors intersection + route non rectiligne +surface anormale + nuit sans éclairage + secu1 voiture

Classe 6 (69 035)
conducteur + indemne + femme + 75 ans et plus
entre 7h et 15h + plein jour + conditions météo normales + collision plusieurs véhicules + surface normale + route sans inclinaison + présence infrastructure + VU/VL

Classe 7 (13 864)
femme + passager
nuit sans éclairage + giratoire + surface anormale + présence d'une infratructure

Classe 8 (26 199)
indemne
secu 1 aucun/autre
VL léger + météo normale + surface normale + sans infrastructure

Classe 9 (38 359)
âges extrèmes (moins de 15 ou 75 ans et +) + femmes + piéton + blessé
voie communale + en agglo


# K-modes

```{r}
mod_kmodes <- kmodes(as.matrix(base), 9) # on prend 9 classes comme ce que la classification a trouvé
```

```{r}
summary(mod_kmodes)
```

## Pour avoir la modalité de chaque variables dans les classes
```{r}
mod_kmodes$modes
```

## Analyse des classes
```{r}
# ajout des classes dans la base
base_comp <- cbind.data.frame(base_comp,classe_kmodes=as.factor(mod_kmodes$cluster))
```

## Quelles modalités sont le plus liées aux modalité de la gravité des blessures ?
```{r}
res_kmodes <- catdes(base_comp, num.var = 2)  # on caractérise la variable "grav" (2e colonne dans la base)
res_kmodes$category
```
même résultat que la classification (rassurant)
