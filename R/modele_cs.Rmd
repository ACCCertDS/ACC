---
title: "Prévisions des accidents ayant entrainés des blessures/décès"
output: html_notebook
author : CS
date : 01/02/2021
---


Librairies utiles à l'éxécution du programme
```{r}
library(tidyverse)
library(glmnet)    # pour la régression logistique
library(lubridate) # pour les dates
library(skimr)     # pour les stat decriptives
library(plotROC)   # Pour la courbe ROC et l'AUC
library(caret)     # pour le passage des données en indicatrices
library(rattle)    # Pour tracer les arbres
```


Création de l'indicatrice accident avec blessures (yc décès) oui/non
```{r}
accidents_M <- accidents %>%
    mutate(accidents, blessures = case_when(
      grav == "Indemne"~ 0,
      TRUE ~ 1) )

skim(accidents_M)
```

Calcul de la proportion indemne/blessé
```{r}
accidents_M$blessures <- as.factor(accidents_M$blessures)
levels(accidents_M$blessures) <- c(0,1)
prop.table(summary(accidents_M$blessures))
```


Création de l'échantillon d'apprentissage
```{r}
don_A <- accidents_M %>%
  filter(year(date_acc) %in% c(2015, 2016, 2017)) %>%
  select(blessures, lum, agg, atm, col, intersection, catr, prof, surf, catv, sexe)

summary(don_A)
# aucune vble manquante

```

calcul de la proportion indemne/blessé pour l'échantillon d'apprentissage
```{r}
don_A$blessures <- as.factor(don_A$blessures)
levels(don_A$blessures) <- c(0,1)
prop.table(summary(don_A$blessures))
# ok proche de la proportion sur la table totale
```

Création de l'échantillon test
```{r}
don_T <- accidents_M %>%
  filter(year((date_acc)) == 2018) %>%
  select(blessures, lum, agg, atm, col, intersection, catr, prof, surf, catv, sexe)

summary(don_T)
# aucune vble manquante
```

calcul de la proportion indemne/blessé pour l'échantillon test
```{r}
don_T$blessures <- as.factor(don_T$blessures)
levels(don_T$blessures) <- c(0,1)
prop.table(summary(don_T$blessures))
# ok proche de la proportion sur la table totale
```

Evaluation de la qualité de la prévision
```{r}
criteres_erreur_classif <- data.frame(Methode_abrev=character(),
                                      Methode=character(),
                                      Error=double(),
                                      Sensitivity=double(),
                                      Precision=double(),
                                      Accuracy=double(),
                                      Specificity=double(),
                                      F1=double(),
                                      AUC=double())

eval_prev_classif <- function(prev_proba,
                              real,
                              methode_abrev,
                              methode){
  prev <- (prev_proba>0.5)*1
  
  cm <- table(real,prev)
  print("Confusion matrix :")
  print(cm)
  assign(paste("cm",methode_abrev,sep="_"),cm,envir=.GlobalEnv)

  cm_norm <- round(100*cm/sum(cm),digits=1)
  print("Confusion matrix (%) :")
  print(cm_norm)
  assign(paste("cm_norm",methode_abrev,sep="_"),cm_norm,envir=.GlobalEnv)
  
  tp <- cm[2,2]
  fp <- cm[1,2]
  tn <- cm[1,1]
  fn <- cm[2,1]

  error <- (fp+fn)/(tp+tn+fp+fn)
  print(paste("Classification error : ",round(error,digits=3),sep=""))
  
  sensitivity <- tp/(tp+fn)
  print(paste("Sensitivity : ",round(sensitivity,digits=3),sep=""))

  precision <- tp/(tp+fp)
  print(paste("Precision : ",round(precision,digits=3),sep=""))
  
  accuracy <- (tp+tn)/(tp+tn+fp+fn)
  print(paste("Accuracy : ",round(accuracy,digits=3),sep=""))

  specificity <- tn/(tn+fp)
  print(paste("Specificity : ",round(specificity,digits=3),sep=""))

  F1 <- 2*precision*sensitivity/(precision+sensitivity)
  print(paste("F1 : ",round(F1,digits=3),sep=""))
  
  if (is.factor(real)==TRUE){
    df <- data.frame(prev_proba=prev_proba,
                     real=as.numeric(real)-1)
  }
  else{
    df <- data.frame(prev_proba=prev_proba,
                     real=real)
  }
  
  graph <- ggplot(df,aes(d=real,m=prev_proba))+
    geom_roc(labels=FALSE)

  AUC <- round(calc_auc(graph)$AUC,digits=2)
  print(paste("AUC : ",round(AUC,digits=3),sep=""))
  
  tab <- get("criteres_erreur_classif",envir=globalenv())
  tab <- rbind(tab,data.frame(Methode_abrev=methode_abrev,
                              Methode=methode,
                              Error=error,
                              Sensitivity=sensitivity,
                              Precision=precision,
                              Accuracy=accuracy,
                              Specificity=specificity,
                              F1=F1,
                              AUC=AUC))
  assign("criteres_erreur_classif",tab,envir=.GlobalEnv)
  
  graph+
    style_roc(theme=theme_grey)+
    annotate("text",x=0.75,y=0.25,label=paste("AUC=",AUC))+
    labs(title="Courbe ROC")
}
```

Régression logistique - estimation du modèle
```{r}
mod <- glm(blessures ~ .,
           data=don_A,
           family="binomial")
summary(mod)


mod_step <- step(mod, direction = "backward")
summary(mod_step)
```


Régression logistique - Prédiction
```{r}
don_T$bles_prev_proba_reglog_step <- predict(mod_step, don_T, type="response")
summary(don_T$bles_prev_proba_reglog_step)
```

Régression logistique - Evaluation du modèle step
```{r}
don_T$bles_prev_reglog_step <- (don_T$bles_prev_proba_reglog_step > 0.5)*1

eval_prev_classif(prev_prob = don_T$bles_prev_proba_reglog_step,
                  real = don_T$blessures,
                  methode_abrev = "reglog",
                  methode = "Régression logistique")
```


Passage des variables à modalités en varaibles qualitatives - utiles pour les estimateurs lasso / ridge / elastic net
```{r}
# échantillon d'apprentissage
dummy_A <- dummyVars(" ~ .", data=don_A[,-1])
don_X_A <- data.frame(predict(dummy_A, newdata = don_A[,-1])) 

don_Y_A <- don_A$blessures

# échantillon test
don_T <- accidents_M %>%
  filter(year((date_acc)) == 2018) %>%
  select(blessures, lum, agg, atm, col, intersection, catr, prof, surf, catv, sexe)

dummy_T <- dummyVars(" ~ .", data=don_T[,-1])
don_X_T <- data.frame(predict(dummy_T, newdata = don_T[,-1])) 
```


Estimateur Lasso - Estimation du modèle
```{r}
lasso <- cv.glmnet(as.matrix(don_X_A), don_Y_A, alpha=1, family="binomial")
 
summary(lasso)
```


Estimateur lasso - Prédiction
```{r}
don_T$bles_prev_lasso <- predict(lasso, as.matrix(don_X_T), type="response")

summary(don_T$bles_prev_lasso)
```

Estimateur lasso - Evaluation du modèle 
```{r}
don_T$bles_prev_lasso <- (don_T$bles_prev_lasso > 0.5)*1

eval_prev_classif(prev_prob = don_T$bles_prev_lasso,
                  real = don_T$blessures,
                  methode_abrev = "lasso",
                  methode = "Estimateur Lasso")
```


Estimateur Ridge - Estimation du modèle
```{r}
ridge <- cv.glmnet(as.matrix(don_X_A), don_Y_A, alpha=0, family="binomial")
 
summary(ridge)
```


Estimateur ridge - Prédiction
```{r}
# échantillon test - on doit relancer le chargement de la table de test pour ne pas avoir la prev lasso dans la table
don_T <- accidents_M %>%
  filter(year((date_acc)) == 2018) %>%
  select(blessures, lum, agg, atm, col, intersection, catr, prof, surf, catv, sexe)

dummy_T <- dummyVars(" ~ .", data=don_T[,-1])
don_X_T <- data.frame(predict(dummy_T, newdata = don_T[,-1])) 

don_T$bles_prev_ridge <- predict(ridge, as.matrix(don_X_T), type="response")
summary(don_T$bles_prev_ridge)
```


Estimateur ridge - Evaluation du modèle 
```{r}
don_T$bles_prev_ridge <- (don_T$bles_prev_ridge > 0.5)*1

eval_prev_classif(prev_prob = don_T$bles_prev_ridge,
                  real = don_T$blessures,
                  methode_abrev = "ridge",
                  methode = "Estimateur Ridge")
```


Estimateur Elastic net - Estimation du modèle
```{r}
ela_net <- cv.glmnet(as.matrix(don_X_A), don_Y_A, alpha=0.5, family="binomial")
 
summary(ela_net)
```


Estimateur Elastic net - Prédiction
```{r}
# échantillon test - on doit relancer le chargement de la table de test pour ne pas avoir la prev lasso dans la table
don_T <- accidents_M %>%
  filter(year((date_acc)) == 2018) %>%
  select(blessures, lum, agg, atm, col, intersection, catr, prof, surf, catv, sexe)

dummy_T <- dummyVars(" ~ .", data=don_T[,-1])
don_X_T <- data.frame(predict(dummy_T, newdata = don_T[,-1])) 

don_T$bles_prev_ela_net <- predict(ela_net, as.matrix(don_X_T), type="response")
summary(don_T$bles_prev_ela_net)
```


Estimateur Elastic net - Evaluation du modèle 
```{r}
don_T$bles_prev_ela_net <- (don_T$bles_prev_ela_net > 0.5)*1

eval_prev_classif(prev_prob = don_T$bles_prev_ela_net,
                  real = don_T$blessures,
                  methode_abrev = "ela_net",
                  methode = "Estimateur Elastic net")
```

CART - Estimation du modèle
```{r}
controle <- trainControl(method="cv",
                         number=5,
                         classProbs=FALSE)
# 5 blocs ici pour accélérer les calculs

cart_caret <- train(blessures ~ .,
                    data=don_A,
                    method="rpart",
                    trControl=controle)

plot(cart_caret$finalModel)
text(cart_caret$finalModel)
```

```{r}
fancyRpartPlot(cart_caret$finalModel,sub="") # A l'aide du package "rattle"
```

CART - Evaluation du modèle
```{r}
don_T$don_T$bles_prev_proba_cart_caret <- predict(cart_caret,
                                                newdata=don_T,
                                                type="prob")[,2]

don_T$don_T$bles_prev_cart_caret <- (don_T$don_T$bles_prev_proba_cart_caret > 0.5) * 1

eval_prev_classif(prev_proba=don_T$don_T$bles_prev_proba_cart_caret,
                  real=don_T$blessures,
                  methode_abrev="cart_caret",
                  methode="CART (caret)")
```


